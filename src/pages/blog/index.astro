---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { formatTitleMla } from '../../utils/titleCase';

const posts = (await getCollection('blog')).sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const formatDate = (date: Date) =>
  date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: '2-digit',
  });

const summarize = (body: string) => {
  const clean = body
    .replace(/^import .*$/gm, '')
    .replace(/<Figure[\s\S]*?\/>/g, '')
    .replace(/!\[.*?\]\(.*?\)/g, '')
    .replace(/\[(.*?)\]\(.*?\)/g, '$1')
    .replace(/^#{1,6}\s*/gm, '')
    .replace(/[`#*>_-]/g, '')
    .replace(/<\/?[^>]+>/g, '')
    .replace(/\s+/g, ' ')
    .trim();
  const words = clean.split(' ').slice(0, 60).join(' ');
  return clean.length > words.length ? `${words}â€¦` : words;
};
---

<BaseLayout pathname="/blog/">
  <div id="blogListing" class="px-2">
    <h1 class="md:pb-8 md:pt-2 dark:text-indigo-100">All Posts</h1>
    {
      posts.map((post) => (
        <article class="py-2 border-t-2 border-gray-300" id={post.slug}>
          <h2>
            <a class="text-indigo-900 dark:text-indigo-200" href={`/blog/${post.slug}/`}>
              {formatTitleMla(post.data.title)}
            </a>
          </h2>
          <p class="my-1 text-gray-700 dark:text-gray-300">
            <strong>Published:</strong> {formatDate(post.data.date)}
          </p>
          <p class="my-2 leading-normal text-gray-900 dark:text-gray-100 prose prose-slate dark:prose-invert max-w-none">
            {summarize(post.body)}
          </p>
          <a
            class="text-indigo-700 hover:text-indigo-900 dark:text-indigo-300 dark:hover:text-indigo-200"
            href={`/blog/${post.slug}/`}
          >
            Read more...
          </a>
        </article>
      ))
    }
  </div>
</BaseLayout>
