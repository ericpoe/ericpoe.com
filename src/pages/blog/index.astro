---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

const posts = (await getCollection('blog')).sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const formatDate = (date: Date) =>
  date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: '2-digit',
  });

const summarize = (body: string) => {
  const clean = body
    .replace(/!\[.*?\]\(.*?\)/g, '')
    .replace(/\[(.*?)\]\(.*?\)/g, '$1')
    .replace(/[`#*>_-]/g, '')
    .replace(/\s+/g, ' ')
    .trim();
  const words = clean.split(' ').slice(0, 60).join(' ');
  return clean.length > words.length ? `${words}â€¦` : words;
};
---

<BaseLayout pathname="/blog/">
  <div id="blogListing" class="px-2">
    <h1 class="md:pb-8 md:pt-2">All Posts</h1>
    {
      posts.map((post) => (
        <article class="py-2 border-t-2 border-gray-300" id={post.slug}>
          <h2>
            <a href={`/blog/${post.slug}/`}>{post.data.title}</a>
          </h2>
          <p class="my-1">
            <strong>Published:</strong> {formatDate(post.data.date)}
          </p>
          <p class="my-2 leading-normal">{summarize(post.body)}</p>
          <a href={`/blog/${post.slug}/`}>Read more...</a>
        </article>
      ))
    }
  </div>
</BaseLayout>
