---
import { getCollection } from 'astro:content';
import readingTime from 'reading-time';
import BlogTimestamp from '../../components/BlogTimestamp.astro';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { formatTitleMla } from '../../utils/titleCase';
import { slugify } from '../../utils/slugify';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.slug },
  }));
}

const { slug } = Astro.params;
const posts = await getCollection('blog');
const post = posts.find((entry) => entry.slug === slug);

if (!post) {
  return Astro.redirect('/404');
}

const { Content } = await post.render();
const createdAt = post.data.date.toISOString();
const updatedAt = post.data.lastEdited?.toISOString();
const timeToRead = Math.max(1, Math.round(readingTime(post.body).minutes));
const keywords = [...(post.data.categories ?? []), ...(post.data.tags ?? [])].join(', ');
---

<BaseLayout
  title={formatTitleMla(post.data.title)}
  description={`${post.body.replace(/\s+/g, ' ').slice(0, 157)}...`}
  pathname={`/blog/${post.slug}/`}
  keywords={keywords}
  articleImage={post.data.featuredImage_Url}
  articleImageAlt={post.data.featuredImage_Alt}
  articleCreatedAt={createdAt}
  articleUpdatedAt={updatedAt}
  type="article"
>
  <section class="leading-normal text-lg">
    <div id="DateTimeInfo">
      <h1>{formatTitleMla(post.data.title)}</h1>
      <BlogTimestamp
        createdAt={new Date(createdAt).toUTCString()}
        lastEditedAt={updatedAt ? new Date(updatedAt).toUTCString() : undefined}
      />
      <p id="timeToRead" class="mt-2">
        <strong>Time to read:</strong>
        {timeToRead}
        {timeToRead > 1 ? 'minutes' : 'minute'}
      </p>
    </div>

    <div id="blogContent" class="leading-normal pt-4 space-y-4 prose prose-slate dark:prose-invert max-w-none">
      <Content />
    </div>
    {
      post.data.tags?.length ? (
        <div class="mt-10 pt-6 border-t border-gray-200 dark:border-gray-700">
          <p class="text-base font-semibold text-gray-800 dark:text-gray-100">Tagged with:</p>
          <div class="flex flex-wrap gap-2 mt-2">
            {post.data.tags.map((tag) => {
              const tagSlug = slugify(tag);
              return (
                <a
                  class="inline-flex items-center px-3 py-1 rounded-full bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-100 text-sm font-medium no-underline hover:bg-indigo-200 dark:hover:bg-indigo-800"
                  href={`/tag/${tagSlug}/`}
                >
                  {tag.replace(/-/g, ' ')}
                </a>
              );
            })}
          </div>
        </div>
      ) : null
    }
  </section>
</BaseLayout>
