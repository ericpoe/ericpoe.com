---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import { formatTitleMla } from '../utils/titleCase';

const allPosts = (await getCollection('blog')).sort((a, b) => b.data.date.getTime() - a.data.date.getTime());
const pageSize = 10;
const pageNumber = 1;
const totalPages = Math.ceil(allPosts.length / pageSize);
const posts = allPosts.slice(0, pageSize);

const formatDate = (date: Date) =>
  date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: '2-digit',
  });

const escapeHtml = (text: string) =>
  text
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');

const balanceCodeTags = (text: string) => {
  const opens = (text.match(/<code>/g) || []).length;
  const closes = (text.match(/<\/code>/g) || []).length;
  if (opens > closes) {
    return `${text}${'</code>'.repeat(opens - closes)}`;
  }
  return text;
};

const summarize = (body: string) => {
  const codeReplaced = body.replace(/```[\s\S]*?```/g, (match) => {
    const code = match.replace(/```/g, '').trim();
    return `<code>${escapeHtml(code)}</code>`;
  });

  const clean = codeReplaced
    .replace(/`([^`]+)`/g, (_m, code) => `<code>${escapeHtml(code)}</code>`)
    .replace(/^import .*$/gm, '')
    .replace(/<Figure[\s\S]*?\/>/g, '')
    .replace(/!\[.*?\]\(.*?\)/g, '')
    .replace(/\[(.*?)\]\(.*?\)/g, '$1')
    .replace(/^>\s*/gm, '')
    .replace(/[_*]{1,2}([^*_]+)[*_]{1,2}/g, '$1')
    .replace(/^#{1,6}\s*/gm, '')
    .replace(/<(?!\/?code\b)[^>]+>/g, '')
    .replace(/\s+/g, ' ')
    .trim();

  const words = clean.split(' ');
  const summary = words.slice(0, 60).join(' ');
  const truncated = clean.length > summary.length ? `${summary}…` : summary;
  return balanceCodeTags(truncated);
};
---

<BaseLayout pathname="/">
  <section id="latestPosts" class="max-w-3xl w-full mx-auto px-4 md:px-6 py-10 md:py-12 space-y-8 md:space-y-10">
    <h1 class="text-3xl md:text-4xl font-semibold dark:text-indigo-100">Latest Posts</h1>
    <div class="space-y-10">
      {
        posts.map((post) => (
          <article class="border-b border-gray-200 pb-8 last:border-b-0" id={post.slug}>
            <h2 class="text-xl md:text-2xl font-semibold text-indigo-900 dark:text-indigo-200">
              <a class="no-underline hover:underline" href={`/blog/${post.slug}/`}>
                {formatTitleMla(post.data.title)}
              </a>
            </h2>
            <p class="mt-2 text-sm md:text-base text-gray-700 dark:text-gray-300">
              <strong>Published:</strong> {formatDate(post.data.date)}
            </p>
            <p class="mt-3 text-base md:text-lg leading-7 text-gray-900 dark:text-gray-100" set:html={summarize(post.body)} />
            <a
              class="mt-4 inline-block font-semibold text-indigo-700 hover:text-indigo-900 dark:text-indigo-300 dark:hover:text-indigo-200"
              href={`/blog/${post.slug}/`}
            >
              Read more...
            </a>
          </article>
        ))
      }
    </div>
    <div class="flex items-center justify-between pt-4 text-indigo-800 font-semibold">
      {pageNumber > 1 ? (
        <a class="hover:text-indigo-900" href={pageNumber === 2 ? '/' : `/page/${pageNumber - 1}/`}>
          ← Previous page
        </a>
      ) : (
        <span />
      )}
      {pageNumber < totalPages && (
        <a class="hover:text-indigo-900" href={`/page/${pageNumber + 1}/`}>
          Next page →
        </a>
      )}
    </div>
  </section>
</BaseLayout>
