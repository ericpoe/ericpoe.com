---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';

const posts = (await getCollection('blog')).sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const formatDate = (date: Date) =>
  date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: '2-digit',
  });

const summarize = (body: string) => {
  const clean = body
    .replace(/^import .*$/gm, '')
    .replace(/<Figure[\s\S]*?\/>/g, '')
    .replace(/!\[.*?\]\(.*?\)/g, '')
    .replace(/\[(.*?)\]\(.*?\)/g, '$1')
    .replace(/^#{1,6}\s*/gm, '')
    .replace(/<\/?[^>]+>/g, '')
    .replace(/\s+/g, ' ')
    .trim();
  const words = clean.split(' ');
  const summary = words.slice(0, 60).join(' ');
  return clean.length > summary.length ? `${summary}â€¦` : summary;
};
---

<BaseLayout pathname="/">
  <section id="latestPosts" class="max-w-3xl w-full mx-auto px-4 md:px-6 py-10 md:py-12 space-y-8 md:space-y-10">
    <h1 class="text-3xl md:text-4xl font-semibold">Latest Posts</h1>
    <div class="space-y-10">
      {
        posts.map((post) => (
          <article class="border-b border-gray-200 pb-8 last:border-b-0" id={post.slug}>
            <h2 class="text-xl md:text-2xl font-semibold text-indigo-900">
              <a class="no-underline hover:underline" href={`/blog/${post.slug}/`}>
                {post.data.title}
              </a>
            </h2>
            <p class="mt-2 text-sm md:text-base text-gray-700">
              <strong>Published:</strong> {formatDate(post.data.date)}
            </p>
            <p class="mt-3 text-base md:text-lg leading-7 text-gray-900">{summarize(post.body)}</p>
            <a
              class="mt-4 inline-block font-semibold text-indigo-700 hover:text-indigo-900"
              href={`/blog/${post.slug}/`}
            >
              Read more...
            </a>
          </article>
        ))
      }
    </div>
  </section>
</BaseLayout>
