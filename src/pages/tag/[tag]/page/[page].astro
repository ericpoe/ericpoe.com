---
import { getCollection } from 'astro:content';
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import { slugify } from '../../../../utils/slugify';
import { formatTitleMla } from '../../../../utils/titleCase';
import { summarizeHtml } from '../../../../utils/summarize';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  const tags = Array.from(new Set(posts.flatMap((post) => post.data.tags ?? []).filter(Boolean)));

  const paths = [];

  for (const tag of tags) {
    const slug = slugify(tag);
    const taggedPosts = posts
      .filter((post) => (post.data.tags ?? []).some((t) => slugify(t) === slug))
      .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());
    const totalPages = Math.ceil(taggedPosts.length / 10);
    for (let page = 2; page <= totalPages; page++) {
      const start = (page - 1) * 10;
      paths.push({
        params: { tag: slug, page: String(page) },
        props: {
          tagName: tag,
          tagSlug: slug,
          pageNumber: page,
          totalPages,
          posts: taggedPosts.slice(start, start + 10),
        },
      });
    }
  }

  return paths;
}

const { tagName, tagSlug, pageNumber, totalPages, posts } = Astro.props;

if (!posts?.length) {
  return Astro.redirect('/404');
}

const formatDate = (date: Date) =>
  date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: '2-digit',
  });
---

<BaseLayout pathname={`/tag/${tagSlug}/page/${pageNumber}/`}>
  <section id="tagPosts" class="max-w-3xl w-full mx-auto px-4 md:px-6 py-10 md:py-12 space-y-8 md:space-y-10">
    <h1 class="text-3xl md:text-4xl font-semibold dark:text-indigo-100">{tagName.replace(/-/g, ' ')}</h1>
    <div class="space-y-10">
      {
        posts.map((post) => (
          <article class="border-b border-gray-300 pb-8 last:border-b-0" id={post.slug}>
            <h2 class="text-xl md:text-2xl font-semibold text-indigo-900 dark:text-indigo-200">
              <a class="no-underline hover:underline" href={`/blog/${post.slug}/`}>
                {formatTitleMla(post.data.title)}
              </a>
            </h2>
            <p class="mt-2 text-sm md:text-base text-gray-700 dark:text-gray-300">
              <strong>Published:</strong> {formatDate(post.data.date)}
            </p>
            <p
              class="mt-3 text-base md:text-lg leading-7 text-gray-900 dark:text-gray-100 prose prose-slate dark:prose-invert max-w-none"
              set:html={summarizeHtml(post.body)}
            />
            <a
              class="mt-4 inline-block font-semibold text-indigo-700 hover:text-indigo-900 dark:text-indigo-300 dark:hover:text-indigo-200"
              href={`/blog/${post.slug}/`}
            >
              Read more...
            </a>
          </article>
        ))
      }
    </div>
    <div class="flex items-center justify-between pt-4 text-indigo-800 dark:text-indigo-200 font-semibold">
      <a
        class="text-indigo-700 hover:text-indigo-900 dark:text-indigo-300 dark:hover:text-indigo-200"
        href={pageNumber === 2 ? `/tag/${tagSlug}/` : `/tag/${tagSlug}/page/${pageNumber - 1}/`}
      >
        ← Previous page
      </a>
      {
        pageNumber < totalPages ? (
          <a
            class="text-indigo-700 hover:text-indigo-900 dark:text-indigo-300 dark:hover:text-indigo-200"
            href={`/tag/${tagSlug}/page/${pageNumber + 1}/`}
          >
            Next page →
          </a>
        ) : (
          <span />
        )
      }
    </div>
  </section>
</BaseLayout>
