---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { formatTitleMla } from '../../utils/titleCase';
import { summarizeHtml } from '../../utils/summarize';

export async function getStaticPaths() {
  const allPosts = (await getCollection('blog')).sort((a, b) => b.data.date.getTime() - a.data.date.getTime());
  const pageSize = 10;
  const totalPages = Math.ceil(allPosts.length / pageSize);

  return Array.from({ length: Math.max(0, totalPages - 1) }, (_, index) => {
    const pageNumber = index + 2; // start at page 2
    const start = (pageNumber - 1) * pageSize;
    return {
      params: { page: String(pageNumber) },
      props: {
        pageNumber,
        totalPages,
        posts: allPosts.slice(start, start + pageSize),
      },
    };
  });
}

const { pageNumber, totalPages, posts } = Astro.props;

const formatDate = (date: Date) =>
  date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: '2-digit',
  });
---

{
  pageNumber > totalPages ? (
    Astro.redirect('/404')
  ) : (
    <BaseLayout pathname={`/page/${pageNumber}/`}>
      <section id="latestPosts" class="max-w-3xl w-full mx-auto px-4 md:px-6 py-10 md:py-12 space-y-8 md:space-y-10">
        <h1 class="text-3xl md:text-4xl font-semibold dark:text-indigo-100">Latest Posts</h1>
        <div class="space-y-10">
          {posts.map((post) => (
            <article class="border-b border-gray-300 pb-8 last:border-b-0" id={post.slug}>
              <h2 class="text-xl md:text-2xl font-semibold text-indigo-900 dark:text-indigo-200">
                <a class="no-underline hover:underline" href={`/blog/${post.slug}/`}>
                  {formatTitleMla(post.data.title)}
                </a>
              </h2>
              <p class="mt-2 text-sm md:text-base text-gray-700 dark:text-gray-300">
                <strong>Published:</strong> {formatDate(post.data.date)}
              </p>
              <p
                class="mt-3 text-base md:text-lg leading-7 text-gray-900 dark:text-gray-100 prose prose-slate dark:prose-invert max-w-none"
                set:html={summarizeHtml(post.body)}
              />
              <a
                class="mt-4 inline-block font-semibold text-indigo-700 hover:text-indigo-900 dark:text-indigo-300 dark:hover:text-indigo-200"
                href={`/blog/${post.slug}/`}
              >
                Read more...
              </a>
            </article>
          ))}
        </div>
        <nav aria-label="Pagination" class="flex items-center justify-between pt-4 text-indigo-800 font-semibold">
          <a
            class="text-indigo-700 hover:text-indigo-900 dark:text-indigo-300 dark:hover:text-indigo-200"
            href={pageNumber === 2 ? '/' : `/page/${pageNumber - 1}/`}
          >
            ← Previous page
          </a>
          {pageNumber < totalPages ? (
            <a
              class="text-indigo-700 hover:text-indigo-900 dark:text-indigo-300 dark:hover:text-indigo-200"
              href={`/page/${pageNumber + 1}/`}
            >
              Next page →
            </a>
          ) : (
            <span />
          )}
        </nav>
      </section>
    </BaseLayout>
  )
}
